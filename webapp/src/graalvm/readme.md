# GraalVM native build prerequisites

To build native image on Windows, one have to install additional tools. See the [official documentation](https://www.graalvm.org/latest/docs/getting-started/windows/#prerequisites-for-using-native-image-on-windows).

There is also a good [tutorial](https://medium.com/graalvm/using-graalvm-and-native-image-on-windows-10-9954dc071311) available.

Once you have all the prerequisites installed, you have to execute the Gradle build from within the __x64 Native Tools Command Prompt for VS 20xx__. The build won't work from any other command prompt.

## Build arguments

The application might not work as expected due to many reasons. I came across reflections and resources problems. There is a good [tutorial](https://bell-sw.com/blog/master-spring-boot-3-with-graalvm-native-image/#mcetoc_1gpv11hri1hsm) how to configure the build.

In short, you have to start the application like a plain java app with an agent attached:
```
<graal-vm>/bin/java -agentlib:native-image-agent=config-output-dir=./config -jar xxx.jar
```
While you are using the application, all resources you are using will be written into the `config` directory. Then you just have to attach the configuration files into the build.

## Spring Boot integration

Spring Boot (v3.1.0 at the time of writing these lines) is [capable](https://docs.spring.io/spring-boot/reference/packaging/native-image/introducing-graalvm-native-images.html#packaging.native-image.introducing-graalvm-native-images.understanding-aot-processing) of creating the config json files, but I found the config files generated by AOT uncompleted.

## Error: Failed to find 'vcvarsall.bat' in a Visual Studio installation

This error.. There are a few solutions in [StackOverflow](https://stackoverflow.com/questions/77840039/graalvm-failed-to-find-vcvarsall-bat-in-a-visual-studio-installation).

_Modifying `native-image.cmd` worked for me._

## "pack" it locally

To simulate GitHub Actions, you can test them locally.

```powershell
pack build gcunicorn:v1.1.1 `
  --builder paketobuildpacks/builder:tiny `
  --buildpack paketo-buildpacks/java-native-image@8.7.1 `
  --path . `
  --env "BP_JVM_VERSION=17" `
  --env "BP_GRADLE_BUILD_ARGUMENTS=--no-daemon :webapp:bootJar" `
  --env "BP_GRADLE_BUILT_ARTIFACT=webapp/build/libs/webapp-1.1.1.jar" `
  --env "BP_INCLUDE_FILES=webapp/src/graalvm/config/v1.1.1/*.json" `
  --env "BP_NATIVE_IMAGE=true" `
  --env "BP_NATIVE_IMAGE_BUILD_ARGUMENTS=--initialize-at-build-time=kotlin.DeprecationLevel --trace-class-initialization=kotlin.DeprecationLevel -H:+ReportExceptionStackTraces -H:ReflectionConfigurationFiles=/workspace/webapp/src/graalvm/config/v1.1.1/reflect-config.json -H:ResourceConfigurationFiles=/workspace/webapp/src/graalvm/config/v1.1.1/resource-config.json"
```

```powershell
docker run --rm -p 8080:8080 gcunicorn:v1.1.1
```